<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="data:image/x-icon;base64,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" rel="icon" type="image/x-icon" />
<title>Koha Offline Library Tool</title>
<style type="text/css">
/* CSS HERE */
body {
  margin: 0px;
  padding: 0px;
}
h1, h2, h3 {
  margin: 0px;
  width: auto;
  color: white;
  background-color: #408540;
  padding-left: 10px;
  line-height: 50px;
}
p {
  margin-left: 10px;
}
.card {
  width: 500px;
  margin: 10px auto;
  border: 1px solid black;

}
.copyright {
  width: 300px; 
  margin: 0px auto;
  text-align: center;
  font-size: 12px;
}
.clear {
  clear: both;
}
.red {
  background-color: salmon;
}
.red_t {
  color: red;
}
.green_t {
  color: green;
}
button {
  padding: 5px;
  border-radius: 3px;
  cursor: pointer;
  border: 1px solid black;
}
button:hover {
  background-color: #4D4D4D;
  color: white;
}
#stage {
  width: auto;
  height: 250px;
  border: 1px solid #e7e7e7;
  margin: auto;
  overflow-y: scroll;
  padding: 10px;
  
}
</style>
</head>
<body>
  <img alt="Koha logo" style="float: left; width: 35px; margin: 8px;" src="data:image/x-icon;base64,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" />
  
<h1>Koha Offline Library Tool</h1>

  <div class="card">
    <h2>Checkin</h2>
    <p>
      Barcode: <input type="tel" id="bar_ckin" onchange="app.checkin()" />
    </p>
    <h2>Checkout</h2>
    <p>
      Patron Card: <input type="tel" id="pat_card" /><br /><br />
      Barcode: <input type="tel" id="bar_ckout"  onchange="app.checkout()"/><br /><br />
    </p>
  </div>
  <div class="card">
    <h2>Results</h2>
    <div id="stage"></div>
  </div>
  <div class="card" style="border:0px;">
    <button onclick="app.save()">Save</button>
    <button onclick="app.download()">Download data (.koc)</button>
    <button onclick="app.clear()"class="red">Clear</button><br /><br />
    <span style="clear: both; font-size: 10px;">*** To upload the .koc file:
    <ul>
      <li>Log-in to Koha through the staff interface and click on "Circulation."
      </li><li>Click on "Upload offline circulation file (.koc)" at the bottom of the screen.
      </li><li>Select your file using the "Choose File" button. 
      </li><li>Click "Upload File" then "Add to offline circulation queue."
      </li><li>From there click "View pending offline circulation actions", then "Check all", then "Process."</li></ul></span><br />
  </div>

<hr class="clear" />
<div class="copyright">
kolt v0.1 created by Kendall Purser<br />
for the <a href="bcld.org" target="_blank">Bonneville County Library District</a><br /> 
and the <a href="https://lcei.lili.org/" target="_blank">Library Consortium of Eastern Idaho</a><br />
Copyright &copy; 2025
</div>
</br />
</br />
<script>
// App here

// .koc file spec: https://wiki.koha-community.org/wiki/Koha_offline_circulation_file_format

const app = {
  header: "Version=1.0\tGenerator=kolt\tGeneratorVersion=0.1\n",
  data: "",
  data2: [],
  get: function (id_in) {
      return document.getElementById(id_in);
  },
  init: function () {
    if(localStorage.getItem("kolt_data")) { 
      app.data = localStorage.getItem("kolt_data");
    } else {
      app.data = app.header;
    }
    app.get("bar_ckin").focus();
    setInterval(app.ui, 1000);
  },
  checkout: function () {
    // date, issue, pat_card, item_barcode
    app.data = app.data + app.get_date() + "\tissue\t" + app.get("pat_card").value + "\t" + app.get("bar_ckout").value + "\n";
    app.get("bar_ckout").value = "";
    app.get("bar_ckout").focus();
    
  },
  checkin: function () {
    // date, return, item_barcode
    app.data = app.data + app.get_date() + "\treturn\t" + app.get("bar_ckin").value + "\n";
    app.get("bar_ckin").value = "";
    app.get("bar_ckin").focus();
  },
  get_date: function () {
    let date_time = new Date().toISOString();
    date_time = date_time.replace("T", " ");
    // date_time = date_time.replace(".", " ");
    date_time = date_time.replace("Z", "");
    date_time = date_time.split(".")[0];
    // console.log(date_time);
    return date_time;
  },
  save: function() {
    localStorage.setItem("kolt_data", app.data);
  },
  download: function() {
    // make file blob and parse string into .koc file format
    let date_time = new Date().toISOString();
    date_time = date_time.replace("T", "_");
    date_time = date_time.replace(":", "-");
    date_time = date_time.replace(":", ".");
    date_time = date_time.split(".")[0];
    const content = app.data;
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kolt_" + date_time + ".koc"
    a.style.display = "none"
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
  },
  clear: function () {
    if(confirm("Delete local data?")){
      localStorage.removeItem("kolt_data");
      app.data = app.header;
      alert("Local data deleted.");
    } else { alert("Canceled."); }
  },
  stage: "",
  ui: function () {
    // update results every second
    app.stage = app.data;
    while (app.stage.indexOf("\n") != -1) {
      app.stage = app.stage.replace("\n", "<br />");      
    }
    while (app.stage.indexOf("\treturn\t") != -1) {
      app.stage = app.stage.replace("\treturn\t", "<span class='green_t'> return </span>");   
    }
    while (app.stage.indexOf("\tissue\t") != -1) {
      app.stage = app.stage.replace("\tissue\t", "<span class='red_t'> issue </span>");  
    }
    app.get("stage").innerHTML = app.stage;
    app.save();
  }
};
app.init();

</script>
</body>
</html>
